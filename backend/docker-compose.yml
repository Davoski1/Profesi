version: '3.9'

services:

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: profesi_postgres
    environment:
      POSTGRES_USER: profesi_user
      POSTGRES_PASSWORD: profesi123
      POSTGRES_DB: profesi_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/02-schema.sql
      - ./database/seed.sql:/docker-entrypoint-initdb.d/03-seed.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U profesi_user -d profesi_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - profesi_network

  # ==========================================
  # pgAdmin - Database Management GUI
  # ==========================================
  pgadmin:
    image: dpage/pgadmin4
    container_name: profesi_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@profesi.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    depends_on:
      - postgres
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - profesi_network
    restart: unless-stopped

  # API Gateway
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: profesi_gateway
    ports:
      - "8000:8000"
    environment:
      - FLASK_ENV=production
      - PORT=8000
      - AUTH_SERVICE_URL=http://auth-service:8001
      - FLOOD_SERVICE_URL=http://flood-prediction:8002
      - TSUNAMI_SERVICE_URL=http://tsunami-prediction:8003
      - WILDFIRE_SERVICE_URL=http://wildfire-prediction:8004
      - EARTHQUAKE_SERVICE_URL=http://earthquake-prediction:8005
      - HAILSTORM_SERVICE_URL=http://hailstorm-prediction:8006
      - WHIRLWIND_SERVICE_URL=http://whirlwind-prediction:8007
      - DATA_INGESTION_URL=http://data-ingestion:8008
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_started
      flood-prediction:
        condition: service_started
      tsunami-prediction:
        condition: service_started
      wildfire-prediction:
        condition: service_started
      earthquake-prediction:
        condition: service_started
      hailstorm-prediction:
        condition: service_started
      whirlwind-prediction:
        condition: service_started
      data-ingestion:
        condition: service_started
    networks:
      - profesi_network
    restart: unless-stopped

  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: profesi_auth_service
    ports:
      - "8001:8001"
    environment:
      - FLASK_ENV=production
      - PORT=8001
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - JWT_SECRET_KEY=c4fff27c-4350-422f-9cd6-bde9185843917e69ee41-b18a-4223-b43e-1368cf3de228
      - JWT_EXPIRATION_HOURS=8
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./auth-service/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Flood Prediction Service
  flood-prediction:
    build:
      context: ./flood-prediction
      dockerfile: Dockerfile
    container_name: profesi_flood_prediction
    ports:
      - "8002:8002"
    environment:
      - FLASK_ENV=production
      - PORT=8002
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MODEL_PATH=/app/models/flood_predictor_v1.pkl
      - SERVICE_NAME=flood-prediction
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./flood-prediction/models:/app/models
      - ./flood-prediction/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Tsunami Prediction Service
  tsunami-prediction:
    build:
      context: ./tsunami-prediction
      dockerfile: Dockerfile
    container_name: profesi_tsunami_prediction
    ports:
      - "8003:8003"
    environment:
      - FLASK_ENV=production
      - PORT=8003
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MODEL_PATH=/app/models/tsunami_predictor_v1.pkl
      - SERVICE_NAME=tsunami-prediction
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./tsunami-prediction/models:/app/models
      - ./tsunami-prediction/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Wildfire Prediction Service
  wildfire-prediction:
    build:
      context: ./wildfire-prediction
      dockerfile: Dockerfile
    container_name: profesi_wildfire_prediction
    ports:
      - "8004:8004"
    environment:
      - FLASK_ENV=production
      - PORT=8004
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MODEL_PATH=/app/models/wildfire_predictor_v1.pkl
      - SERVICE_NAME=wildfire-prediction
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./wildfire-prediction/models:/app/models
      - ./wildfire-prediction/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Earthquake Prediction Service
  earthquake-prediction:
    build:
      context: ./earthquake-prediction
      dockerfile: Dockerfile
    container_name: profesi_earthquake_prediction
    ports:
      - "8005:8005"
    environment:
      - FLASK_ENV=production
      - PORT=8005
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MODEL_PATH=/app/models/earthquake_predictor_v1.pkl
      - SERVICE_NAME=earthquake-prediction
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./earthquake-prediction/models:/app/models
      - ./earthquake-prediction/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Hailstorm Prediction Service
  hailstorm-prediction:
    build:
      context: ./hailstorm-prediction
      dockerfile: Dockerfile
    container_name: profesi_hailstorm_prediction
    ports:
      - "8006:8006"
    environment:
      - FLASK_ENV=production
      - PORT=8006
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MODEL_PATH=/app/models/hailstorm_predictor_v1.pkl
      - SERVICE_NAME=hailstorm-prediction
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./hailstorm-prediction/models:/app/models
      - ./hailstorm-prediction/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Whirlwind Prediction Service
  whirlwind-prediction:
    build:
      context: ./whirlwind-prediction
      dockerfile: Dockerfile
    container_name: profesi_whirlwind_prediction
    ports:
      - "8007:8007"
    environment:
      - FLASK_ENV=production
      - PORT=8007
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MODEL_PATH=/app/models/whirlwind_predictor_v1.pkl
      - SERVICE_NAME=whirlwind-prediction
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./whirlwind-prediction/models:/app/models
      - ./whirlwind-prediction/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Data Ingestion Service
  data-ingestion:
    build:
      context: ./data-ingestion
      dockerfile: Dockerfile
    container_name: profesi_data_ingestion
    ports:
      - "8008:8008"
    environment:
      - FLASK_ENV=production
      - PORT=8008
      - DATABASE_URL=postgresql://profesi_user:profesi123@postgres:5432/profesi_db
      - MAX_FILE_SIZE=52428800
      - UPLOAD_FOLDER=/app/uploads
      - SERVICE_NAME=data-ingestion
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./data-ingestion/uploads:/app/uploads
      - ./data-ingestion/logs:/app/logs
    networks:
      - profesi_network
    restart: unless-stopped

  # Frontend React Application
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: profesi_frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    depends_on:
      - gateway
    networks:
      - profesi_network
    restart: unless-stopped

volumes:
  postgres_data:
  pgadmin_data:  # âœ… NEW: pgAdmin data persistence

networks:
  profesi_network:
    driver: bridge
